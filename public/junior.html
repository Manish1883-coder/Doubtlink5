<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Junior Profile - DoubtLink</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { margin:0; font-family:'Segoe UI',sans-serif; background:#121212; color:#fff; }
    header { background:linear-gradient(90deg,#6a0dad,#4b0082); padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; }
    header h1{ margin:0; font-size:2rem; }
    header nav a{ color:#fff; text-decoration:none; margin-left:1.5rem; font-weight:bold; }
    header nav a:hover{ color:#ff69b4; }

    .container{ max-width:900px; margin:2rem auto; padding:0 1rem; }
    .profile-info{ background:#1f1f1f; padding:1rem; border-radius:10px; margin-bottom:2rem; }
    .profile-info h2{ margin:0 0 .5rem 0; color:#ff69b4; }
    .profile-info p{ margin:.3rem 0; }

    .doubt-section{ background:#1f1f1f; padding:1rem; border-radius:10px; margin-bottom:2rem; }
    .doubt-section input,.doubt-section select{ padding:.5rem; border-radius:5px; border:none; background:#2a2a2a; color:#fff; margin-right:.5rem; }
    .doubt-section input[type="text"]{ width:40%; }
    .doubt-section select{ width:25%; }
    .doubt-section button{ padding:.5rem 1rem; border:none; border-radius:5px; background:linear-gradient(90deg,#6a0dad,#4b0082); color:#fff; font-weight:bold; cursor:pointer; }

    .doubt-list{ margin-top:2rem; }
    .doubt-card{ background:#1f1f1f; padding:1rem; border-radius:10px; margin-bottom:1rem; }
    .doubt-card h4{ margin:0 0 .5rem 0; color:#ff69b4; }
    .doubt-card p{ margin:.3rem 0; }
    .image-preview img{ max-width:200px; margin-top:.5rem; border-radius:6px; display:block; }
    .image-preview a{ color:#ff69b4; display:block; margin-top:.2rem; text-decoration:none; }
    .messages{ margin-top:.6rem; display:flex; flex-direction:column; gap:.4rem; }
    .msg{ padding:.4rem .6rem; border-radius:8px; max-width:70%; }
    .me{ background:#2a2a2a; align-self:flex-end; }
    .other{ background:#23232f; align-self:flex-start; }
    .reply-actions{ margin-top:.6rem; display:flex; gap:.5rem; flex-wrap:wrap; }
    .reply-actions input[type="text"]{ flex:1; padding:.4rem; border-radius:5px; border:none; background:#2a2a2a; color:#fff; }
    .meeting-btn{ margin-top:.5rem; padding:.4rem .8rem; border:none; border-radius:5px; background:linear-gradient(90deg,#ff69b4,#ff1493); color:#fff; font-weight:bold; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <h1>DoubtLink</h1>
    <nav>
      <a href="leaderboard.html">Leaderboard</a>
      <a href="index.html">Logout</a>
    </nav>
  </header>

  <div class="container">
    <!-- Junior Profile Info -->
    <div class="profile-info">
      <h2 id="juniorName">Junior Name</h2>
      <p><strong>Year:</strong> <span id="juniorYear">Loading...</span></p>
      <p><strong>Course:</strong> <span id="juniorCourse">Loading...</span></p>
    </div>

    <!-- Doubt Asking Section -->
    <div class="doubt-section">
      <input type="text" id="doubtInput" placeholder="Enter your doubt">
      <select id="seniorSelect">
        <option value="all">Send to All Seniors</option>
      </select>
      <input type="file" id="imageInput" accept="image/*">
      <button id="postDoubtBtn">Post Doubt</button>
    </div>

    <!-- Doubt List -->
    <div class="doubt-list" id="doubtList">
      <h2>Your Doubts & Answers</h2>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const token = localStorage.getItem("token");
    let currentUser = null;

    const juniorNameEl = document.getElementById('juniorName');
    const juniorYearEl = document.getElementById('juniorYear');
    const juniorCourseEl = document.getElementById('juniorCourse');
    const doubtListEl = document.getElementById('doubtList');
    const postDoubtBtn = document.getElementById('postDoubtBtn');
    const seniorSelect = document.getElementById('seniorSelect');

    // Helper API call
    async function api(path, options={}) {
      const headers = options.headers || {};
      headers['Authorization'] = `Bearer ${token}`;
      const res = await fetch(path, { ...options, headers });
      return res.json();
    }

    // Load profile
    async function loadProfile() {
      const res = await fetch('/me', { headers: { Authorization: `Bearer ${token}` }});
      if (res.ok) {
        currentUser = await res.json();
        juniorNameEl.innerText = currentUser.username;
        juniorYearEl.innerText = currentUser.year;
        juniorCourseEl.innerText = currentUser.course;
      }
    }

    // Load seniors
    async function loadSeniors() {
      const res = await fetch('/seniors', { headers: { Authorization: `Bearer ${token}` }});
      if (res.ok) {
        const seniors = await res.json();
        seniors.forEach(s => {
          const option = document.createElement('option');
          option.value = s._id;
          option.innerText = s.username;
          seniorSelect.appendChild(option);
        });
      }
    }

    // Render one doubt
    function renderDoubt(doubt) {
      const card = document.createElement('div');
      card.className = 'doubt-card';
      card.dataset.id = doubt._id;

      const h4 = document.createElement('h4');
      h4.innerText = "You asked:";
      card.appendChild(h4);

      const p = document.createElement('p');
      p.innerText = doubt.text;
      card.appendChild(p);

      if (doubt.imageUrl) {
        const imgDiv = document.createElement('div');
        imgDiv.className = 'image-preview';
        imgDiv.innerHTML = `
          <img src="${doubt.imageUrl}" alt="Image">
          <a href="${doubt.imageUrl}" download>Download Image</a>
        `;
        card.appendChild(imgDiv);
      }

      // Messages container
      const messagesDiv = document.createElement('div');
      messagesDiv.className = 'messages';
      if (doubt.messages) {
        doubt.messages.forEach(m => appendMessage(messagesDiv, m, m.sender === currentUser._id));
      }
      card.appendChild(messagesDiv);

      // Reply actions
      const replyActions = document.createElement('div');
      replyActions.className = 'reply-actions';
      const msgInput = document.createElement('input');
      msgInput.type = 'text';
      msgInput.placeholder = 'Type your message...';
      const imgInput = document.createElement('input');
      imgInput.type = 'file';
      imgInput.accept = 'image/*';
      const sendBtn = document.createElement('button');
      sendBtn.innerText = 'Send';
      sendBtn.onclick = async () => {
        const text = msgInput.value.trim();
        const file = imgInput.files[0];
        if (!text && !file) return;
        let imageUrl = null;
        if (file) {
          const fd = new FormData();
          fd.append('image', file);
          const upRes = await fetch('/upload', { method:'POST', headers:{ Authorization:`Bearer ${token}` }, body:fd });
          const upData = await upRes.json();
          imageUrl = upData.url;
        }
        socket.emit('chat:send', { doubtId:doubt._id, text, imageUrl });
        msgInput.value = '';
        imgInput.value = '';
      };
      replyActions.appendChild(msgInput);
      replyActions.appendChild(imgInput);
      replyActions.appendChild(sendBtn);
      card.appendChild(replyActions);

      // Meeting button
      const meetBtn = document.createElement('button');
      meetBtn.className = 'meeting-btn';
      meetBtn.innerText = 'Start Meeting';
      meetBtn.onclick = () => {
        const link = `https://meet.jit.si/DoubtLink_${doubt._id}`;
        window.open(link, "_blank");
      };
      card.appendChild(meetBtn);

      doubtListEl.appendChild(card);
    }

    // Append one message
    function appendMessage(container, msg, isMe) {
      const div = document.createElement('div');
      div.className = `msg ${isMe ? 'me':'other'}`;
      if (msg.text) div.innerText = msg.text;
      if (msg.imageUrl) {
        div.innerHTML = `<img src="${msg.imageUrl}" style="max-width:150px;border-radius:6px;" />`;
      }
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    // Post doubt
    postDoubtBtn.addEventListener('click', async () => {
      const doubtInput = document.getElementById('doubtInput');
      const file = document.getElementById('imageInput').files[0];
      const senior = seniorSelect.value;
      if (!doubtInput.value.trim() && !file) return alert("Enter doubt or upload image");

      const formData = new FormData();
      formData.append('text', doubtInput.value);
      formData.append('senior', senior);
      if (file) formData.append('image', file);

      const res = await fetch('/doubts', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}` },
        body: formData
      });
      const doubt = await res.json();
      renderDoubt(doubt);
      doubtInput.value = '';
      document.getElementById('imageInput').value = '';
    });

    // Listen for replies / chat
    socket.on('chat:receive', ({ doubtId, message }) => {
      const card = document.querySelector(`.doubt-card[data-id="${doubtId}"]`);
      if (card) {
        const messagesDiv = card.querySelector('.messages');
        appendMessage(messagesDiv, message, message.sender === currentUser._id);
      }
    });

    // Init
    loadProfile();
    loadSeniors();
  </script>
</body>
</html>
