<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Senior Profile - DoubtLink</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { margin:0; font-family:'Segoe UI',sans-serif; background:#121212; color:#fff; }
    header { background:linear-gradient(90deg,#6a0dad,#4b0082); padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; }
    header h1{ margin:0; font-size:2rem; }
    header nav a{ color:#fff; text-decoration:none; margin-left:1.5rem; font-weight:bold; }
    header nav a:hover{ color:#ff69b4; }

    .container{ max-width:900px; margin:2rem auto; padding:0 1rem; }
    .profile-card{ background:#1f1f1f; padding:1.5rem; border-radius:10px; margin-bottom:2rem; text-align:center; }
    .profile-card h2{ margin:0; font-size:1.8rem; color:#ff69b4; }
    .profile-card p{ margin:.3rem 0; font-size:1.1rem; }

    .points-badges{ display:flex; justify-content:space-between; margin-bottom:2rem; background:#1f1f1f; padding:1rem; border-radius:10px; }
    .points-badges div{text-align:center;}
    .points-badges h3{ margin:.5rem 0; color:#ff69b4; }

    .group-meeting{ background:#1f1f1f; padding:1rem; border-radius:10px; margin-bottom:2rem; }

    .doubt-list{ margin-top:2rem; }
    .doubt-card{ background:#1f1f1f; padding:1rem; border-radius:10px; margin-bottom:1rem; position:relative; }
    .doubt-card h4{ margin:0 0 .5rem 0; color:#ff69b4; }
    .doubt-card p{ margin:.3rem 0; }
    .image-preview img{ max-width:200px; margin-top:.5rem; border-radius:6px; display:block; }
    .image-preview a{ color:#ff69b4; display:block; margin-top:.2rem; text-decoration:none; }

    .reply-section{ margin-top:.5rem; display:flex; gap:.5rem; flex-wrap:wrap; }
    .reply-section input[type="text"]{ flex:1; padding:.4rem; border-radius:5px; border:none; background:#2a2a2a; color:#fff; }
    .reply-section input[type="file"]{ flex:none; }
    .reply-section button{ padding:.4rem .8rem; border:none; border-radius:5px; background:linear-gradient(90deg,#6a0dad,#4b0082); color:#fff; font-weight:bold; cursor:pointer; }
    .meeting-btn{ margin-top:.5rem; padding:.4rem .8rem; border:none; border-radius:5px; background:linear-gradient(90deg,#ff69b4,#ff1493); color:#fff; font-weight:bold; cursor:pointer; display:inline-block; }

    .messages{ margin-top:.6rem; display:flex; flex-direction:column; gap:.4rem; }
    .msg{ padding:.4rem .6rem; border-radius:8px; max-width:70%; }
    .me{ background:#2a2a2a; align-self:flex-end; }
    .other{ background:#23232f; align-self:flex-start; }

    @media(max-width:768px){ .points-badges{ flex-direction:column; gap:1rem; } }
  </style>
</head>
<body>
  <header>
    <h1>DoubtLink</h1>
    <nav>
      <a href="leaderboard.html">Leaderboard</a>
      <a href="index.html">Logout</a>
    </nav>
  </header>

  <div class="container">
    <div class="profile-card">
      <h2 id="seniorName">Loading...</h2>
      <p id="seniorYear">Year: --</p>
      <p id="seniorCourse">Course: --</p>
    </div>

    <div class="points-badges">
      <div><h3>Points</h3><p id="points">0</p></div>
      <div><h3>Badges</h3><p id="badges">None</p></div>
    </div>

    <div class="group-meeting">
      <h2>Start Group Meeting</h2>
      <div id="juniorSelection"></div>
      <button class="meeting-btn" onclick="startGroupMeeting()">Start Meeting</button>
    </div>

    <div class="doubt-list" id="doubtList">
      <h2>Junior Doubts</h2>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const API_BASE = "https://doubtlink5.onrender.com";
    const socket = io(API_BASE);
    const token = localStorage.getItem("token");
    let seniorData = null;

    const seniorNameEl = document.getElementById("seniorName");
    const seniorYearEl = document.getElementById("seniorYear");
    const seniorCourseEl = document.getElementById("seniorCourse");
    const doubtList = document.getElementById('doubtList');
    const juniorSelectionDiv = document.getElementById("juniorSelection");

    // Load profile
    async function loadProfile() {
      const res = await fetch(`${API_BASE}/me`, { headers:{Authorization:`Bearer ${token}`}});
      if(res.ok){
        seniorData = await res.json();
        seniorNameEl.innerText = seniorData.name;
        seniorYearEl.innerText = "Year: " + (seniorData.year || "--");
        seniorCourseEl.innerText = "Course: " + (seniorData.course || "--");
        document.getElementById('points').innerText = seniorData.points || 0;
        document.getElementById('badges').innerText = (seniorData.badges || 0) + " Badges";
      }
    }

    // Load juniors
    async function loadJuniors() {
      const res = await fetch(`${API_BASE}/juniors`, { headers:{Authorization:`Bearer ${token}`}});
      if(res.ok){
        const juniors = await res.json();
        juniorSelectionDiv.innerHTML = "";
        juniors.forEach(j => {
          juniorSelectionDiv.innerHTML += `<label><input type="checkbox" value="${j._id}"> ${j.name}</label><br>`;
        });
      }
    }

    // Start group meeting and save in backend
    async function startGroupMeeting(){
      const selected = [...juniorSelectionDiv.querySelectorAll('input:checked')].map(cb=>cb.value);
      if(selected.length===0){ return alert("Select juniors"); }
      const res = await fetch(`${API_BASE}/start-meeting/group`, {
        method:"POST",
        headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` },
        body: JSON.stringify({ juniors:selected })
      });
      const data = await res.json();
      if(res.ok) window.open(data.meetingLink,"_blank");
    }

    // Doubt card
    function createDoubtCard(d){
      const card = document.createElement('div');
      card.className='doubt-card';
      card.dataset.id=d._id;
      card.innerHTML=`
        <h4>${d.askedBy?.name} asked:</h4>
        <p>${d.text}</p>
        ${d.imageUrl?`<div class="image-preview"><img src="${d.imageUrl}"></div>`:""}
        <p><strong>Answer:</strong> ${d.reply || "<em>Not answered yet</em>"}</p>
        ${d.meetingLink?`<a href="${d.meetingLink}" target="_blank" class="meeting-btn">Join Meeting</a>`:""}
        <div class="reply-section">
          <input type="text" placeholder="Write answer">
          <button>Send</button>
        </div>
      `;
      const btn = card.querySelector('button');
      const input = card.querySelector('input');
      btn.onclick = async ()=>{
        if(!input.value.trim()) return;
        const res = await fetch(`${API_BASE}/doubts/${d._id}/answer`, {
          method:"POST",
          headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` },
          body: JSON.stringify({ answer: input.value })
        });
        const data = await res.json();
        if(res.ok){
          input.value="";
          card.querySelector("p strong").parentNode.innerHTML = `<strong>Answer:</strong> ${data.reply}`;
          socket.emit("chat:send",{ doubtId:d._id, text:data.reply });
          loadProfile(); // refresh points/badges
        }
      };
      doubtList.appendChild(card);
    }

    // Load doubts
    async function loadDoubts() {
      const res = await fetch(`${API_BASE}/doubts`, { headers:{Authorization:`Bearer ${token}`}});
      if(res.ok){
        const doubts = await res.json();
        doubtList.innerHTML = "<h2>Junior Doubts</h2>";
        doubts.forEach(d=>createDoubtCard(d));
      }
    }

    // Sockets
    socket.on("doubt:new",d=>createDoubtCard(d));

    // Init
    loadProfile();
    loadJuniors();
    loadDoubts();
  </script>
</body>
</html>
